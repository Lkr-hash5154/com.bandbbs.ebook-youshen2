<template>
	<div class="page">
		<list class="list" style="padding: 86px 6px 6px 6px;">
			<!-- 封面图片（如果有）作为列表的第一项 -->
			<list-item if="{{hasCover}}" type="cover" style="height: 192px; align-items: center; justify-content: center; margin-bottom: 12px;">
				<img src="{{coverPath}}" style="width: 120px;height: 160px;object-fit: cover;border-radius: 12px;" />
			</list-item>
			
			<list-item class="item" type="info">
				<text class="item-title">文件名</text>
				<marquee class="item-value" scrollamount="50" text-offset="25">{{fileName}}</marquee>
			</list-item>
			<list-item class="item" type="info" if="{{author}}">
				<text class="item-title">作者</text>
				<marquee class="item-value" scrollamount="50" text-offset="25">{{author}}</marquee>
			</list-item>
			<list-item class="item" type="info" style="height: 280px; flex-direction: column;">
				<text class="item-title">占用空间</text>
				<marquee scrollamount="20" class="item-value">{{totalStorage}}</marquee>
				<div style="width: 100%; height: 1px; background-color: rgba(255,255,255,0.2); margin: 8px 0px;"></div>
				<text class="item-title" style="font-size: 20px;">章节占用</text>
				<text class="item-value" style="font-size: 20px;">{{chapterStorage}}</text>
				<text class="item-title" style="font-size: 20px;">封面占用</text>
				<text class="item-value" style="font-size: 20px;">{{coverStorage}}</text>
				<text class="item-title" style="font-size: 20px;">索引占用</text>
				<text class="item-value" style="font-size: 20px;">{{indexStorage}}</text>
			</list-item>
			<list-item class="item" type="info">
				<text class="item-title">同步进度</text>
				<marquee class="item-value" scrollamount="50" text-offset="25">{{syncProgress}}</marquee>
			</list-item>
			<list-item class="item" type="info">
				<text class="item-title">总字数</text>
				<marquee scrollamount="20" class="item-value">{{wordCount}}</marquee>
			</list-item>
			<list-item class="item" type="info" if="{{bookStatus}}">
				<text class="item-title">状态</text>
				<text class="item-value">{{bookStatus}}</text>
			</list-item>
			<list-item class="item" type="info" if="{{category}}">
				<text class="item-title">分类</text>
				<text class="item-value">{{category}}</text>
			</list-item>
			<list-item class="item" type="summary" if="{{summary}}" @click="showSummary">
				<text class="item-title">书籍简介</text>
				<text class="item-value" style="color: rgba(255,255,255,0.8);">点击查看 →</text>
			</list-item>
		</list>

		<img static src="/common/images/hd.png" style="position: absolute;left: 0px;top: 0px;width: 192px;height: 102px;" />
		
		<text style="position: absolute;left: 44px;top: 12px;width: 104px;line-height: 32px;font-weight:bold;font-size:20px;color:rgba(255,255,255,0.6);text-align:center;">
			{{nowTime}}
		</text>
		<text style="position: absolute;left: 24px;top: 40px;width: 144px;line-height: 42px;font-weight:bold;font-size:28px;color:white;text-align:center;">
			书籍详情
		</text>
	</div>
</template>

<script>
import router from '@system.router'
import file from '@system.file'
import runAsyncFunc from '../../utils/runAsyncFunc.js'
import storage from '../../common/storage.js'

export default {
	private: {
		fileName: '加载中...',
		totalStorage: '加载中...',
		chapterStorage: '加载中...',
		coverStorage: '加载中...',
		indexStorage: '加载中...',
		wordCount: '加载中...',
		nowTime: "00:00",
		timer: null,
		hasCover: false,
		coverPath: '',
		author: '',
		summary: '',
		bookStatus: '',
		category: '',
		syncProgress: '计算中...',
        timeFormat: '24h'
	},
	protected: {
		cPath: '',
		name: ''
	},
	updateTime() {
		const date = new Date();
		let hours = date.getHours();
		let minutes = date.getMinutes();
        if (this.timeFormat === '12h') {
            let ampm = hours >= 12 ? '下午' : '上午';
            hours = hours % 12;
            hours = hours ? hours : 12; 
            minutes = minutes < 10 ? '0' + minutes : minutes;
            this.nowTime = `${ampm} ${hours}:${minutes}`;
        } else {
            hours = hours < 10 ? '0' + hours : hours;
            minutes = minutes < 10 ? '0' + minutes : minutes;
            this.nowTime = `${hours}:${minutes}`;
        }
	},
	onInit() {
        storage.get({
            key: 'EBOOK_TIME_FORMAT',
            success: (data) => {
                if(data) this.timeFormat = data;
                this.updateTime();
            },
            fail: () => {
                this.updateTime();
            }
        });
		this.timer = setInterval(() => {
			this.updateTime();
		}, 1000);
		this.loadFileInfo();
	},
	onDestroy() {
		clearInterval(this.timer);
	},
	showSummary() {
		router.push({
			uri: 'pages/textReader',
			params: {
				pageTitle: '简介',
				pageContent: this.summary
			}
		});
	},
	async loadFileInfo() {
		const that = this;
		const bookContentDirUri = `internal://files/books/${this.name}/content/`;
		const bookInfoUri = `internal://files/books/${this.name}/book_info.json`;
		const listUri = `internal://files/books/${this.name}/list.txt`;
		const coverUri = `internal://files/books/${this.name}/cover.jpg`;

		file.readText({
			uri: bookInfoUri,
			success: function(data) {
				try {
					const info = JSON.parse(data.text);
					that.fileName = info.name || that.name;
					that.wordCount = info.wordCount ? `${info.wordCount} 字` : '未知';
					that.hasCover = info.hasCover || false;
					if (that.hasCover) {
						that.coverPath = coverUri;
					}
					that.author = info.author || '';
					that.summary = info.summary || '';
					that.bookStatus = info.bookStatus || '';
					that.category = info.category || '';

					that.calculateSyncProgress(info.chapterCount, listUri);
				} catch (e) {
					that.fileName = that.name;
					that.wordCount = '解析失败';
					that.syncProgress = '未知';
				}
			},
			fail: function(data, code) {
				that.fileName = that.name;
				that.wordCount = '加载失败';
				that.syncProgress = '未知';
			}
		});


		this.totalStorage = '计算中...';
		this.chapterStorage = '计算中...';
		this.coverStorage = '计算中...';
		this.indexStorage = '计算中...';
		try {
			let totalSize = 0;
			let chapterSize = 0;
			let coverSize = 0;
			let indexSize = 0;
			try {
				const listResult = await runAsyncFunc(file.list, { uri: bookContentDirUri });
				if (listResult.fileList) {
					for (const f of listResult.fileList) {
						if (f.type === 'file') {
							chapterSize += f.length;
						}
					}
				}
			} catch(e) { }
			this.chapterStorage = this.formatFileSize(chapterSize);
			totalSize += chapterSize;
			try {
				const coverInfo = await runAsyncFunc(file.get, { uri: coverUri });
				coverSize = coverInfo.length;
			} catch (e) {
				coverSize = 0;
			}
			this.coverStorage = this.formatFileSize(coverSize);
			totalSize += coverSize;
			try {
				const bookInfo = await runAsyncFunc(file.get, { uri: bookInfoUri });
				indexSize += bookInfo.length;
			} catch (e) { }
			try {
				const listInfo = await runAsyncFunc(file.get, { uri: listUri });
				indexSize += listInfo.length;
			} catch (e) { }
			this.indexStorage = this.formatFileSize(indexSize);
			totalSize += indexSize;

			this.totalStorage = this.formatFileSize(totalSize);
		} catch (e) {
			this.totalStorage = '计算失败';
			this.chapterStorage = '计算失败';
			this.coverStorage = '计算失败';
			this.indexStorage = '计算失败';
		}
	},
	async calculateSyncProgress(totalChapters, listUri) {
		if (typeof totalChapters !== 'number' || totalChapters <= 0) {
			this.syncProgress = '无需同步';
			return;
		}

		try {
			const listData = await runAsyncFunc(file.readText, { uri: listUri });
			const syncedChapters = listData.text.split('\n').filter(Boolean).length;
			const progress = Math.floor((syncedChapters / totalChapters) * 100);
			this.syncProgress = `${progress}% (${syncedChapters}/${totalChapters}章)`;
		} catch (e) {
			this.syncProgress = `0% (0/${totalChapters}章)`;
		}
	},
	formatFileSize(bytes) {
		if (bytes === 0) return '0 Bytes';
		const k = 1024;
		const sizes = ['Bytes', 'KB', 'MB', 'GB'];
		const i = Math.floor(Math.log(bytes) / Math.log(k));
		return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
	},
	formatTime(timestamp) {
		if (!timestamp) return '未知';
		const date = new Date(timestamp);
		const year = date.getFullYear();
		const month = ('0' + (date.getMonth() + 1)).slice(-2);
		const day = ('0' + date.getDate()).slice(-2);
		const hours = ('0' + date.getHours()).slice(-2);
		const minutes = ('0' + date.getMinutes()).slice(-2);
		return `${year}-${month}-${day} ${hours}:${minutes}`;
	},
	back() {
		router.back();
	}
}
</script>

<style>
.page {
	width: 192px;
	height: 490px;
	background-color: #000000;
}
.list {
	width: 192px;
	height: 490px;
	position: absolute;
	top: 0px;
	left: 0px;
}
.item {
	width: 100%;
	height: 112px;
	padding: 14px 20px;
	margin-bottom: 8px;
	background-color: #262626;
	border-radius: 36px;
	flex-direction: column;
	align-items: flex-start;
	justify-content: space-around;
}
.item-title {
	font-size: 24px;
	line-height: 32px;
	font-weight: bold;
	color: rgba(255,255,255,0.6);
}
.item-value {
	font-size: 28px;
	line-height: 36px;
	width: 100%;
	font-weight: bold;
	color: white;
	text-overflow: ellipsis;
	lines: 1;
}
</style>
